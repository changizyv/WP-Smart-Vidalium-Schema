# Database Structure in WP-Smart-Vidalium-Schema

This document details the database structure of the **WP-Smart-Vidalium-Schema** WordPress plugin, designed to enhance **Generative Engine Optimization (GEO)** through automated JSON-LD schema generation. The plugin uses four custom database tables to manage schema storage, synchronization, settings, and schema type definitions. A key focus is on how schemas are stored and linked to page elements, ensuring accurate and efficient structured data delivery for AI-driven search engines. All tables are optimized for performance on shared hosting, using the `InnoDB` engine and `utf8mb4` charset for WordPress compatibility and multilingual support, including right-to-left (RTL) languages like Persian.

## Overview
The plugin relies on four tables:
1. **wp_ai_schema_blocks**: Stores JSON-LD schemas and their mappings to page elements.
2. **wp_ai_schema_sync_log**: Tracks synchronization issues for schema consistency.
3. **wp_ai_schema_settings**: Manages plugin configuration settings.
4. **wp_ai_schema_types**: Defines schema types, detection patterns, and JSON-LD templates.

These tables enable the plugin to generate, store, and link schemas to specific content, ensuring relevance for GEO while maintaining lightweight performance.

## Table Details

### 1. wp_ai_schema_blocks
**Purpose**: Stores JSON-LD schemas for pages, posts, or custom post types, including metadata to link schemas to specific DOM elements and track content changes.

**Schema**:
```sql
CREATE TABLE wp_ai_schema_blocks (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    post_id BIGINT UNSIGNED NOT NULL,
    schema_type VARCHAR(100) NOT NULL,
    schema_json LONGTEXT NOT NULL,
    xpath_selector TEXT NOT NULL,
    element_hash VARCHAR(32) NOT NULL,
    sync_status ENUM('valid', 'changed', 'missing') DEFAULT 'valid',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_post_id (post_id),
    INDEX idx_schema_type (schema_type)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

**Fields**:
| Field            | Type                     | Description                                                                 |
|------------------|--------------------------|-----------------------------------------------------------------------------|
| `id`             | BIGINT UNSIGNED          | Primary key, auto-incremented.                                              |
| `post_id`        | BIGINT UNSIGNED          | ID of the associated post or page.                                         |
| `schema_type`    | VARCHAR(100)             | Schema type (e.g., `FAQPage`, `Product`, `Article`).                        |
| `schema_json`    | LONGTEXT                 | JSON-LD code for the schema, generated or user-selected.                   |
| `xpath_selector` | TEXT                     | XPath of the DOM element linked to the schema (e.g., `/html/body/div[2]`). |
| `element_hash`   | VARCHAR(32)              | MD5 hash of the element’s content for change detection.                    |
| `sync_status`    | ENUM('valid', 'changed', 'missing') | Status of schema synchronization with page content.               |
| `created_at`     | DATETIME                 | Timestamp of record creation.                                              |
| `updated_at`     | DATETIME                 | Timestamp of last update.                                                  |

**Storage and Linking**:
- **Schema Storage**: The `schema_json` field stores the full JSON-LD code (e.g., `{"@type": "FAQPage", "mainEntity": [...]}`), generated by `AIAnalyzer.php` or manually selected via `schema-selector.php`.
- **Linking to Page Elements**: The `xpath_selector` field uses XPath (generated by `DOMHelper.php`) to map the schema to a specific DOM element (e.g., a `<div>` containing FAQs). This ensures precise association between schemas and content, critical for GEO accuracy.
- **Change Detection**: The `element_hash` field stores an MD5 hash of the DOM element’s content. On post updates (`save_post` hook), `SchemaController.php` compares the current hash with `element_hash`. If they differ, `sync_status` updates to `changed` or `missing`, triggering a conflict report in `sync-report.php`.
- **GEO Role**: Accurate schema storage and element linking ensure AI-driven search engines interpret content correctly, boosting discoverability for queries like FAQs or product details.

**Implementation Notes**:
- Managed by `SchemaModel.php` for CRUD operations.
- Sanitized using WordPress functions (e.g., `sanitize_text_field`) for security.
- Indexes (`idx_post_id`, `idx_schema_type`) optimize queries for schema retrieval.

### 2. wp_ai_schema_sync_log
**Purpose**: Logs synchronization issues when schemas no longer match page content due to edits or deletions, ensuring schema reliability for GEO.

**Schema**:
```sql
CREATE TABLE wp_ai_schema_sync_log (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    post_id BIGINT UNSIGNED NOT NULL,
    schema_id BIGINT UNSIGNED NOT NULL,
    old_hash VARCHAR(32) NOT NULL,
    new_hash VARCHAR(32) DEFAULT NULL,
    status ENUM('valid', 'changed', 'missing') DEFAULT 'valid',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (schema_id) REFERENCES wp_ai_schema_blocks(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

**Fields**:
| Field         | Type                     | Description                                                                 |
|---------------|--------------------------|-----------------------------------------------------------------------------|
| `id`          | BIGINT UNSIGNED          | Primary key, auto-incremented.                                              |
| `post_id`     | BIGINT UNSIGNED          | ID of the associated post or page.                                         |
| `schema_id`   | BIGINT UNSIGNED          | ID of the schema in `wp_ai_schema_blocks`.                                 |
| `old_hash`    | VARCHAR(32)              | MD5 hash of the element’s content before the change.                       |
| `new_hash`    | VARCHAR(32)              | MD5 hash of the element’s current content (NULL if element is missing).    |
| `status`      | ENUM('valid', 'changed', 'missing') | Synchronization status of the schema.                             |
| `created_at`  | DATETIME                 | Timestamp of the log entry.                                                |

**Storage and Linking**:
- **Schema Synchronization**: When content changes (e.g., editing an FAQ section), `SchemaController.php` compares `element_hash` from `wp_ai_schema_blocks` with the current content hash. Mismatches are logged here with `old_hash` (previous) and `new_hash` (current).
- **Linking to Elements**: The `schema_id` foreign key ties logs to specific schemas in `wp_ai_schema_blocks`, ensuring traceability to the affected DOM element via `xpath_selector`.
- **GEO Role**: Maintains schema accuracy by flagging outdated schemas, ensuring AI search engines receive up-to-date structured data.

**Implementation Notes**:
- Triggered by `save_post` hook in `vidalium-smart-schema.php`.
- Displayed in the conflict report UI (`sync-report.php`).
- Errors are logged for debugging, accessible via `SchemaAPI.php`.

### 3. wp_ai_schema_settings
**Purpose**: Stores plugin settings, such as active schemas and JSON-LD insertion location, to customize schema generation and linking.

**Schema**:
```sql
CREATE TABLE wp_ai_schema_settings (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    setting_key VARCHAR(100) NOT NULL,
    setting_value LONGTEXT NOT NULL,
    post_type VARCHAR(50) DEFAULT NULL,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_setting_key (setting_key),
    INDEX idx_post_type (post_type)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

**Fields**:
| Field            | Type                     | Description                                                                 |
|------------------|--------------------------|-----------------------------------------------------------------------------|
| `id`             | BIGINT UNSIGNED          | Primary key, auto-incremented.                                              |
| `setting_key`    | VARCHAR(100)             | Setting name (e.g., `insert_location`, `active_schemas`).                   |
| `setting_value`  | LONGTEXT                 | Setting value, serialized if complex (e.g., array of active schemas).       |
| `post_type`      | VARCHAR(50)              | Associated post type (optional, for post-type-specific settings).           |
| `updated_at`     | DATETIME                 | Timestamp of last update.                                                  |

**Storage and Linking**:
- **Schema Storage**: Stores settings like `active_schemas` (e.g., `["Article", "FAQPage"]`) to limit which schemas are available for generation, indirectly affecting `wp_ai_schema_blocks`.
- **Linking to Elements**: Settings like `insert_location` (head/footer) determine where JSON-LD (from `schema_json`) is injected, ensuring compatibility with page structure.
- **GEO Role**: Enables user-controlled schema generation, aligning structured data with content intent for AI-driven search engines.

**Implementation Notes**:
- Managed by `SchemaModel.php` and accessed via `settings.php` or `SchemaAPI.php`.
- Uses `maybe_serialize` for complex data storage.

### 4. wp_ai_schema_types
**Purpose**: Stores definitions for 24 schema.org types, including detection patterns and JSON-LD templates, to guide schema generation and linking.

**Schema**:
```sql
CREATE TABLE wp_ai_schema_types (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    schema_type VARCHAR(100) NOT NULL,
    description TEXT DEFAULT NULL,
    detection_patterns LONGTEXT NOT NULL,
    json_template LONGTEXT NOT NULL,
    related_post_types VARCHAR(255) DEFAULT NULL,
    priority INT DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_schema_type (schema_type)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

**Fields**:
| Field               | Type                     | Description                                                                 |
|---------------------|--------------------------|-----------------------------------------------------------------------------|
| `id`                | BIGINT UNSIGNED          | Primary key, auto-incremented.                                              |
| `schema_type`       | VARCHAR(100)             | Schema type (e.g., `Article`, `FAQPage`).                                   |
| `description`       | TEXT                     | User-friendly description for the admin UI.                                 |
| `detection_patterns`| LONGTEXT                 | JSON-encoded patterns (keywords, HTML, URLs) for content analysis.         |
| `json_template`     | LONGTEXT                 | JSON-LD template for the schema.                                           |
| `related_post_types`| VARCHAR(255)             | Associated post types (e.g., `post`, `page`, `product`).                   |
| `priority`          | INT                      | Priority for suggestion ranking.                                           |
| `created_at`        | DATETIME                 | Timestamp of record creation.                                              |

**Storage and Linking**:
- **Schema Storage**: The `json_template` field stores the base JSON-LD structure (e.g., `{"@type": "Product", "name": ""}`), populated by `AIAnalyzer.php` or user input.
- **Linking to Elements**: The `detection_patterns` field (JSON-encoded) includes HTML patterns (e.g., `<h3>` + `<p>` for FAQs) and keywords, used by `AIAnalyzer.php` to match schemas to DOM elements. The resulting schema is stored in `wp_ai_schema_blocks` with its `xpath_selector`.
- **GEO Role**: Provides the foundation for accurate schema suggestions, ensuring AI search engines receive relevant structured data.

**Implementation Notes**:
- Managed by `SchemaModel.php` and used by `AIAnalyzer.php` for pattern-based detection.
- Extensible for adding new schema types in future releases.

## Schema Storage and Element Linking Details
- **Storage Process**:
  1. The content analysis algorithm (`AIAnalyzer.php`) scans page HTML, URLs, and Elementor widgets to suggest schemas.
  2. Suggested or user-selected schemas are stored in `wp_ai_schema_blocks` with their `schema_json` (JSON-LD) and `xpath_selector` (DOM location).
  3. `SchemaModel.php` sanitizes and saves the data, ensuring up to 5 schemas per page.
- **Element Linking**:
  - **XPath**: Generated by `DOMHelper.php`, `xpath_selector` identifies the exact DOM element (e.g., `/html/body/section[1]/div[2]`) tied to the schema. This ensures precise mapping, e.g., linking an FAQPage schema to an accordion widget.
  - **Element Hash**: An MD5 hash of the element’s content (generated by `DOMHelper.php`) is stored in `element_hash`. On post updates, `SchemaController.php` recalculates the hash to detect changes, updating `sync_status` if needed.
  - **Example**: For a page with an FAQ section, `AIAnalyzer.php` detects an `elementor-accordion` widget, suggests an FAQPage schema, and stores it in `wp_ai_schema_blocks` with:
    - `schema_type`: `FAQPage`
    - `schema_json`: `{"@type": "FAQPage", "mainEntity": [...]}` 
    - `xpath_selector`: `/html/body/div[3]/section[1]`
    - `element_hash`: `a1b2c3d4e5f6...`
- **GEO Impact**: Precise linking ensures AI search engines associate schemas with the correct content, improving ranking for queries like “What is X?” (FAQPage) or product searches (Product).

## Database Design Considerations
- **Performance**: Indexes (`idx_post_id`, `idx_schema_type`, `idx_setting_key`) optimize frequent queries. `LONGTEXT` fields support complex JSON-LD without size limits.
- **Data Integrity**: The `schema_id` foreign key in `wp_ai_schema_sync_log` ensures consistency with `wp_ai_schema_blocks` via `ON DELETE CASCADE`.
- **Scalability**: Tables support high volumes of schemas and logs, suitable for large sites.
- **GEO Optimization**: Accurate storage and linking of schemas enhance content discoverability in AI-driven search results.
- **Error Handling**: Errors during schema storage or synchronization are logged in `wp_ai_schema_sync_log` or PHP error logs, accessible via `utils.php`.

## Key Files
- **SchemaModel.php**: Handles database operations for all tables.
- **vidalium-smart-schema.php**: Triggers synchronization via `save_post` hook.
- **AIAnalyzer.php**: Uses `wp_ai_schema_types` for schema detection.
- **DOMHelper.php**: Generates `xpath_selector` and `element_hash`.
- **SchemaController.php**: Manages schema processing and conflict detection.
- **SchemaAPI.php**: Provides REST API access to table data.

For details on schema generation, see [Schema Usage](schema-usage.md). For the plugin’s architecture, refer to [Architecture](architecture.md).